import os
import random
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CallbackQueryHandler,
    ContextTypes,
)

# -----------------------------
# 1Ô∏è‚É£ –¢–æ–∫–µ–Ω
# -----------------------------
TOKEN = os.getenv("TOKEN")
if not TOKEN:
    raise ValueError("–¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü—Ä–æ–≤–µ—Ä—å Environment Variables –Ω–∞ Railway")
TOKEN = TOKEN.strip()

# -----------------------------
# 2Ô∏è‚É£ –ü–∞–ø–∫–∞ —Å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è–º–∏
# -----------------------------
PHOTOS_DIR = "photos"
photo_files = [f for f in os.listdir(PHOTOS_DIR) if f.endswith(".jpg")]
photo_files.sort()
if not photo_files:
    raise ValueError("–í –ø–∞–ø–∫–µ photos –Ω–µ—Ç jpg —Ñ–∞–π–ª–æ–≤!")

# -----------------------------
# 3Ô∏è‚É£ –§—Ä–∞–∑—ã
# -----------------------------
PHRASES = [
    "–õ–µ–Ω–æ—á–∫–∞, —Ç—ã –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–∞—è, –Ω–µ –∑–∞–±—ã–≤–∞–π –æ–± —ç—Ç–æ–º üå∏",
    "–î—ã—à–∏ –≥–ª—É–±–æ–∫–æ, –≤—Å—ë –Ω–∞–ª–∞–¥–∏—Ç—Å—è, —è –≤–µ—Ä—é –≤ —Ç–µ–±—è ‚ù§Ô∏è",
    "–¢—ã —Å–∏–ª—å–Ω–∞—è, —Å–º–µ–ª–∞—è –∏ –∑–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–∞—è, –õ–µ–Ω–æ—á–∫–∞ üåà",
    "–ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π —Å–ª–∏—à–∫–æ–º —Å–∏–ª—å–Ω–æ, –º–∏—Ä –ª—é–±–∏—Ç —Ç–µ–±—è üåº",
    "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å ‚Äî –Ω–æ–≤–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å, –õ–µ–Ω–æ—á–∫–∞ ‚ú®",
    "–¢—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å —Å—á–∞—Å—Ç—å—è –∏ —Ç–µ–ø–ª–∞, –Ω–µ –∑–∞–±—ã–≤–∞–π üå∑",
    "–õ–µ–Ω–æ—á–∫–∞, –ø–æ–º–Ω–∏, —á—Ç–æ —Ç–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ –≤–∞–∂–Ω—ã –∏ –∏—Ö –º–æ–∂–Ω–æ –æ—Ç–ø—É—Å—Ç–∏—Ç—å üíõ",
    "–¢—ã –º–æ–∂–µ—à—å –≤—Å—ë, —á—Ç–æ –∑–∞–¥—É–º–∞–ª–∞, –ø—Ä–æ—Å—Ç–æ –ø–æ–≤–µ—Ä—å –≤ —Å–µ–±—è üí´",
    "–°–º–µ–π—Å—è, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è —Ç—Ä—É–¥–Ω–æ, –õ–µ–Ω–æ—á–∫–∞ üò∫",
    "–¢—ã –¥–µ–ª–∞–µ—à—å –º–∏—Ä —è—Ä—á–µ, –ø—Ä–æ—Å—Ç–æ –±—É–¥—å —Å–æ–±–æ–π üåü",
    "–õ–µ–Ω–æ—á–∫–∞, –≤—Å—ë, —á—Ç–æ —Ç–µ–±—è —Ç—Ä–µ–≤–æ–∂–∏—Ç, –ø—Ä–æ–π–¥—ë—Ç üïäÔ∏è",
    "–ù–µ —Å–ø–µ—à–∏, –¥—ã—à–∏ –∏ –¥–µ–ª–∞–π –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞–≥–∏ üå∏",
    "–¢—ã —É–∂–µ –ø—Ä–æ–¥–µ–ª–∞–ª–∞ –æ–≥—Ä–æ–º–Ω—É—é —Ä–∞–±–æ—Ç—É, –õ–µ–Ω–æ—á–∫–∞ üëè",
    "–õ—é–±–æ–π —à—Ç–æ—Ä–º –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è, –∏ —Å–æ–ª–Ω—Ü–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤—ã–π–¥–µ—Ç ‚òÄÔ∏è",
    "–õ–µ–Ω–æ—á–∫–∞, –∑–Ω–∞–π: —Ç–≤–æ—è –¥–æ–±—Ä–æ—Ç–∞ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –º–∏—Ä –ª—É—á—à–µ üíñ",
    "–¢—ã —É–º–µ–µ—à—å —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å —Ç—Ä—É–¥–Ω–æ—Å—Ç—è–º–∏, –¥–∞–∂–µ –µ—Å–ª–∏ —Å–µ–π—á–∞—Å —Ç—è–∂–µ–ª–æ üå∑",
    "–ü–æ–∑–≤–æ–ª—å —Å–µ–±–µ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å –∏ —É–ª—ã–±–Ω—É—Ç—å—Å—è üòä",
    "–õ–µ–Ω–æ—á–∫–∞, —Ç—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –ª—é–±–≤–∏ –∏ –∑–∞–±–æ—Ç—ã üåπ",
    "–ö–∞–∂–¥–æ–µ —Ç–≤–æ—ë —á—É–≤—Å—Ç–≤–æ –≤–∞–∂–Ω–æ, –Ω–µ –ø–æ–¥–∞–≤–ª—è–π –µ–≥–æ üíõ",
    "–¢—ã –Ω–µ –æ–¥–Ω–∞, –º–∏—Ä –∏ —è —Å —Ç–æ–±–æ–π üåà",
    "–õ–µ–Ω–æ—á–∫–∞, —Å–µ–≥–æ–¥–Ω—è —Ö–æ—Ä–æ—à–∏–π –¥–µ–Ω—å –¥–ª—è –º–∞–ª–µ–Ω—å–∫–æ–π —Ä–∞–¥–æ—Å—Ç–∏ üçÄ",
    "–¢—ã —Ç–∞–ª–∞–Ω—Ç–ª–∏–≤–∞, —É–º–Ω–∞ –∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞ üåü",
    "–ù–µ –±–æ–π—Å—è –æ—à–∏–±–æ–∫, –æ–Ω–∏ –¥–µ–ª–∞—é—Ç —Ç–µ–±—è —Å–∏–ª—å–Ω–µ–µ üí´",
    "–õ–µ–Ω–æ—á–∫–∞, —É–ª—ã–±–Ω–∏—Å—å, –¥–∞–∂–µ –º–∞–ª–µ–Ω—å–∫–∞—è —É–ª—ã–±–∫–∞ ‚Äî —ç—Ç–æ –º–∞–≥–∏—è üò∫",
    "–¢—ã —Å–ø–æ—Å–æ–±–Ω–∞ –Ω–∞ –±–æ–ª—å—à–µ–µ, —á–µ–º –¥—É–º–∞–µ—à—å üåº",
    "–í—Å—ë –±—É–¥–µ—Ç —Ö–æ—Ä–æ—à–æ, –ø—Ä–æ—Å—Ç–æ –¥–æ–≤–µ—Ä—è–π —Å–µ–±–µ üå∑",
    "–õ–µ–Ω–æ—á–∫–∞, —Ç—ã —É–¥–∏–≤–∏—Ç–µ–ª—å–Ω–∞—è, –Ω–µ —Å–æ–º–Ω–µ–≤–∞–π—Å—è üå∏",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –º–∏–Ω—É—Ç–∫–∞ –ø–æ–∫–æ—è –∏ —Ç–µ–ø–ª–∞ üíñ",
    "–¢—ã —É–º–µ–µ—à—å —Å–ø—Ä–∞–≤–ª—è—Ç—å—Å—è —Å –ª—é–±—ã–º–∏ –±—É—Ä—è–º–∏, –õ–µ–Ω–æ—á–∫–∞ üïäÔ∏è",
    "–ü–æ–º–Ω–∏, —á—Ç–æ –º–∞–ª–µ–Ω—å–∫–∏–µ –ø–æ–±–µ–¥—ã ‚Äî —ç—Ç–æ —Ç–æ–∂–µ —É—Å–ø–µ—Ö üåü",
    "–õ–µ–Ω–æ—á–∫–∞, –ø–æ–∑–≤–æ–ª—å —Å–µ–±–µ –ø–æ—á—É–≤—Å—Ç–≤–æ–≤–∞—Ç—å —Ä–∞–¥–æ—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è üòä",
    "–¢—ã –¥–æ—Å—Ç–æ–π–Ω–∞ —Å–∞–º—ã—Ö —Ç—ë–ø–ª—ã—Ö —Å–ª–æ–≤ –∏ –æ–±—ä—è—Ç–∏–π üíõ",
    "–î–∞–∂–µ –≤ —Ç—Ä—É–¥–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã —Ç—ã –æ—Å—Ç–∞—ë—à—å—Å—è –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–π üå∑",
    "–õ–µ–Ω–æ—á–∫–∞, —Ç–≤–æ—è —ç–Ω–µ—Ä–≥–∏—è –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –º–∏—Ä —Å–≤–µ—Ç–ª–µ–µ ‚ú®",
    "–î–æ–≤–µ—Ä—è–π —Å–µ–±–µ, —Ç—ã –≤—Å—ë —Å–º–æ–∂–µ—à—å üí´",
    "–¢—ã —É–∂–µ –º–Ω–æ–≥–æ –ø—Ä–æ—à–ª–∞, –≥–æ—Ä–¥–∏—Å—å —Å–æ–±–æ–π üåπ",
    "–õ–µ–Ω–æ—á–∫–∞, –∏–Ω–æ–≥–¥–∞ –æ—Ç–¥—ã—Ö ‚Äî —ç—Ç–æ –ª—É—á—à–∏–π —Å–ø–æ—Å–æ–± –±—ã—Ç—å —Å–∏–ª—å–Ω–æ–π üåº",
    "–¢—ã –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞ —Ç–∞–∫–æ–π, –∫–∞–∫–∞—è –µ—Å—Ç—å üò∫",
    "–ü—É—Å—Ç—å —Å–µ–≥–æ–¥–Ω—è –±—É–¥–µ—Ç –º–∞–ª–µ–Ω—å–∫–æ–µ —á—É–¥–æ –¥–ª—è —Ç–µ–±—è üíñ",
    "–õ–µ–Ω–æ—á–∫–∞, —Ç–≤–æ—è —É–ª—ã–±–∫–∞ ‚Äî —ç—Ç–æ —Å–æ–ª–Ω—Ü–µ –¥–ª—è –¥—Ä—É–≥–∏—Ö üå∏",
    "–¢—ã —Å–ø–æ—Å–æ–±–Ω–∞ –Ω–∞ –Ω–µ–≤–µ—Ä–æ—è—Ç–Ω–æ–µ, –ø–æ–≤–µ—Ä—å üåà",
    "–î–∞–∂–µ –µ—Å–ª–∏ —Ç—è–∂–µ–ª–æ, –∫–∞–∂–¥—ã–π —à–∞–≥ ‚Äî —ç—Ç–æ –ø—Ä–æ–≥—Ä–µ—Å—Å üå∑",
    "–õ–µ–Ω–æ—á–∫–∞, –±—É–¥—å –º—è–≥–∫–æ–π –∫ —Å–µ–±–µ, —Ç—ã –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—à—å –∑–∞–±–æ—Ç—ã üïäÔ∏è",
    "–¢—ã —É–Ω–∏–∫–∞–ª—å–Ω–∞, –ø–æ–º–Ω–∏ –æ–± —ç—Ç–æ–º ‚ú®",
    "–õ–µ–Ω–æ—á–∫–∞, –∫–∞–∂–¥—ã–π —Ç–≤–æ–π –¥–µ–Ω—å ‚Äî —ç—Ç–æ –º–∞–ª–µ–Ω—å–∫–∞—è –ø–æ–±–µ–¥–∞ üíõ",
    "–¢—ã —Å–≤–µ—Ç–∏—à—å –¥–∞–∂–µ –≤ —Å–∞–º—ã–µ –ø–∞—Å–º—É—Ä–Ω—ã–µ –¥–Ω–∏ üåü",
    "–õ–µ–Ω–æ—á–∫–∞, —Ç—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è —Å —ç—Ç–∏–º, —è –∑–Ω–∞—é üò∫",
    "–ü—É—Å—Ç—å –ª—é–±–æ–≤—å –∫ —Å–µ–±–µ —Å—Ç–∞–Ω–µ—Ç —Ç–≤–æ–µ–π —Å–∏–ª–æ–π üå∏",
    "–¢—ã –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞, –¥–∞–∂–µ –∫–æ–≥–¥–∞ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è üíñ",
    "–õ–µ–Ω–æ—á–∫–∞, –¥–æ–≤–µ—Ä—è–π —Å–≤–æ–∏–º –æ—â—É—â–µ–Ω–∏—è–º –∏ —á—É–≤—Å—Ç–≤–∞–º üå∑",
    "–ö–∞–∂–¥–æ–µ —É—Ç—Ä–æ ‚Äî —à–∞–Ω—Å –Ω–∞—á–∞—Ç—å —Å —á–∏—Å—Ç–æ–≥–æ –ª–∏—Å—Ç–∞ üåà"
]

# -----------------------------
# 4Ô∏è‚É£ –§—É–Ω–∫—Ü–∏–∏ –±–æ—Ç–∞
# -----------------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üìú –§—Ä–∞–∑–∞", callback_data="phrase")],
        [InlineKeyboardButton("üê∂ –§–æ—Ç–æ", callback_data="photo")],
        [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data="help")],
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(
        f"–ü—Ä–∏–≤–µ—Ç, {update.effective_user.first_name}! –Ø —Ç–≤–æ–π –¥—Ä—É–∂–æ–∫ —Å –º–∏–ª—ã–º–∏ —Ñ—Ä–∞–∑–∞–º–∏ –∏ —Ñ–æ—Ç–æ üêæ",
        reply_markup=reply_markup
    )

async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    user_name = update.effective_user.first_name or "–¥—Ä—É–≥"

    if query.data == "phrase":
        text = random.choice(PHRASES).format(name=user_name)
        await query.edit_message_text(text)
        # —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        keyboard = [
            [InlineKeyboardButton("üìú –§—Ä–∞–∑–∞", callback_data="phrase")],
            [InlineKeyboardButton("üê∂ –§–æ—Ç–æ", callback_data="photo")],
            [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data="help")],
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.message.reply_text("–í—ã–±–∏—Ä–∞–π –¥–∞–ª—å—à–µ:", reply_markup=reply_markup)

    elif query.data == "photo":
        photo_path = os.path.join(PHOTOS_DIR, random.choice(photo_files))
        await query.message.reply_photo(photo=open(photo_path, "rb"))
        # —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        keyboard = [
            [InlineKeyboardButton("üìú –§—Ä–∞–∑–∞", callback_data="phrase")],
            [InlineKeyboardButton("üê∂ –§–æ—Ç–æ", callback_data="photo")],
            [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data="help")],
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.message.reply_text("–í—ã–±–∏—Ä–∞–π –¥–∞–ª—å—à–µ:", reply_markup=reply_markup)

    elif query.data == "help":
        help_text = (
            "–ú–µ–Ω—é –±–æ—Ç–∞:\n"
            "üìú –§—Ä–∞–∑–∞ ‚Äî –ø—Ä–∏—Å—ã–ª–∞—é –º–∏–ª—É—é —Ñ—Ä–∞–∑—É üå∏\n"
            "üê∂ –§–æ—Ç–æ ‚Äî –ø—Ä–∏—Å—ã–ª–∞—é –º–∏–ª—É—é —Ñ–æ—Ç–∫—É üê∂\n"
            "‚ùì –ü–æ–º–æ—â—å ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ"
        )
        await query.edit_message_text(help_text)
        # —Å–Ω–æ–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏
        keyboard = [
            [InlineKeyboardButton("üìú –§—Ä–∞–∑–∞", callback_data="phrase")],
            [InlineKeyboardButton("üê∂ –§–æ—Ç–æ", callback_data="photo")],
            [InlineKeyboardButton("‚ùì –ü–æ–º–æ—â—å", callback_data="help")],
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.message.reply_text("–í—ã–±–∏—Ä–∞–π –¥–∞–ª—å—à–µ:", reply_markup=reply_markup)

# -----------------------------
# 5Ô∏è‚É£ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
# -----------------------------
app = ApplicationBuilder().token(TOKEN).build()
app.add_handler(CallbackQueryHandler(button_handler))
app.add_handler(CallbackQueryHandler(button_handler, pattern=".*"))  # –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫

# -----------------------------
# 6Ô∏è‚É£ –ó–∞–ø—É—Å–∫
# -----------------------------
if __name__ == "__main__":
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!")
    app.run_polling()
